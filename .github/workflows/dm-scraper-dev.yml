name: DM Scraper (Development)

on:
  # Manual trigger only for development testing
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (process only first 10 products)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  # Trigger on push to development branch for testing
  push:
    branches: [development]
    paths:
      - 'scripts/dm-scraper.mjs'
      - 'src/lib/services/scrapers/dm-scraper.ts'
      - '.github/workflows/dm-scraper-dev.yml'

jobs:
  scrape-dm-prices-dev:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Shorter timeout for development

    steps:
      - name: ğŸš€ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ•·ï¸ Install Chrome dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3-dev \
            libatk-bridge2.0-dev \
            libdrm-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxrandr-dev \
            libgbm-dev \
            libxss-dev \
            libasound2-dev

      - name: ğŸ§ª Run DM Scraper (Development Mode)
        env:
          # WooCommerce Configuration
          WOOCOMMERCE_URL: ${{ secrets.WOOCOMMERCE_URL }}
          WOOCOMMERCE_CONSUMER_KEY: ${{ secrets.WOOCOMMERCE_CONSUMER_KEY }}
          WOOCOMMERCE_CONSUMER_SECRET: ${{ secrets.WOOCOMMERCE_CONSUMER_SECRET }}

          # WooCommerce HR Configuration (if needed)
          WOOCOMMERCE_HR_URL: ${{ secrets.WOOCOMMERCE_HR_URL }}
          WOOCOMMERCE_HR_CONSUMER_KEY: ${{ secrets.WOOCOMMERCE_HR_CONSUMER_KEY }}
          WOOCOMMERCE_HR_CONSUMER_SECRET: ${{ secrets.WOOCOMMERCE_HR_CONSUMER_SECRET }}

          # Development mode flag
          NODE_ENV: development
          TEST_MODE: ${{ github.event.inputs.test_mode || 'true' }}
        run: |
          echo "ğŸ§ª Starting DM Scraper in DEVELOPMENT mode at $(date)"
          echo "ğŸ“‹ Test mode: $TEST_MODE"
          echo "ğŸ“‹ Branch: ${{ github.ref_name }}"
          echo "ğŸ“‹ Commit: ${{ github.sha }}"
          node scripts/dm-scraper.mjs
          echo "âœ… DM Scraper development test completed at $(date)"

      - name: ğŸ“Š Upload development logs
        uses: actions/upload-artifact@v4
        if: always() # Upload logs even if scraper fails
        with:
          name: dm-scraper-dev-logs-${{ github.run_number }}
          path: |
            logs/
            *.log
          retention-days: 7 # Shorter retention for dev logs

      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'push' && github.ref != 'refs/heads/main'
        run: |
          echo "ğŸ“ Development DM Scraper test completed"
          echo "ğŸ”— Check logs in artifacts: dm-scraper-dev-logs-${{ github.run_number }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“Š This was a development test run"
